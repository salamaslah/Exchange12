<!DOCTYPE html>
<html>
<head>
    <title>ØªØ­Ø¯ÙŠØ« Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f0fdf4;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #065f46;
            text-align: center;
        }
        button {
            background: #10b981;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        button:hover {
            background: #059669;
        }
        #output {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù Ù…Ù† ExchangeRate-API</h1>

        <button onclick="updateRates()">â–¶ï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¢Ù†</button>
        <button onclick="checkRates()">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>

        <div id="output"></div>
    </div>

    <script type="module">
        const SUPABASE_URL = 'https://drmfvptsuvrqmsqtpzse.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJib2x0IiwicmVmIjoiMGVjOTBiNTdkNmU5NWZjYmRhMTk4MzJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4ODE1NzQsImV4cCI6MTc1ODg4MTU3NH0.9I8-U0x86Ak8t2DGaIk0HfvTSLsAyzdnz-Nw00mMkKw';
        const API_KEY = '6375a29a46d85cb492b9e541';

        const rates = {
            'USD': 3.29, 'EUR': 3.86, 'GBP': 4.42, 'SAR': 0.88,
            'AED': 0.90, 'JOD': 4.64, 'KWD': 10.87, 'QAR': 0.90,
            'EGP': 0.07, 'TRY': 0.12, 'CAD': 2.36, 'AUD': 2.17,
            'CHF': 4.14, 'JPY': 0.02, 'CNY': 0.46, 'RUB': 0.03,
            'SEK': 0.35, 'NOK': 0.32, 'DKK': 0.52, 'SGD': 2.55,
            'HKD': 0.42, 'KRW': 0.0025, 'THB': 0.10, 'MXN': 0.19, 'BRL': 0.62
        };

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const span = document.createElement('span');
            span.className = type;
            span.textContent = message + '\n';
            output.appendChild(span);
            output.scrollTop = output.scrollHeight;
        }

        window.updateRates = async function() {
            const output = document.getElementById('output');
            output.innerHTML = '';
            log('ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø±...', 'info');

            let successCount = 0;
            let errorCount = 0;

            for (const [code, currentRate] of Object.entries(rates)) {
                try {
                    // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø©
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/currencies?code=eq.${code}&select=id,buy_commission,sell_commission`,
                        {
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`
                            }
                        }
                    );

                    const currencies = await response.json();

                    if (!currencies || currencies.length === 0) {
                        log(`âš ï¸  ${code}: Ø§Ù„Ø¹Ù…Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©`, 'error');
                        errorCount++;
                        continue;
                    }

                    const currency = currencies[0];
                    const buyCommission = (currency.buy_commission || 6) / 100;
                    const sellCommission = (currency.sell_commission || 6) / 100;

                    const buyRate = Math.round((currentRate - buyCommission) * 100) / 100;
                    const sellRate = Math.round((currentRate + sellCommission) * 100) / 100;

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„Ø©
                    const updateResponse = await fetch(
                        `${SUPABASE_URL}/rest/v1/currencies?id=eq.${currency.id}`,
                        {
                            method: 'PATCH',
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=minimal'
                            },
                            body: JSON.stringify({
                                current_rate: currentRate,
                                buy_rate: buyRate,
                                sell_rate: sellRate,
                                updated_at: new Date().toISOString()
                            })
                        }
                    );

                    if (updateResponse.ok) {
                        log(`âœ… ${code}: ${currentRate.toFixed(2)} | Ø´Ø±Ø§Ø¡: ${buyRate.toFixed(2)} | Ø¨ÙŠØ¹: ${sellRate.toFixed(2)}`, 'success');
                        successCount++;
                    } else {
                        log(`âŒ ${code}: ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«`, 'error');
                        errorCount++;
                    }

                } catch (error) {
                    log(`âŒ ${code}: ${error.message}`, 'error');
                    errorCount++;
                }
            }

            log(`\nğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬:`, 'info');
            log(`   âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­: ${successCount} Ø¹Ù…Ù„Ø©`, 'success');
            log(`   âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${errorCount} Ø¹Ù…Ù„Ø©`, 'error');
            log(`   ğŸ“… ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleString('ar')}`, 'info');
        };

        window.checkRates = async function() {
            const output = document.getElementById('output');
            output.innerHTML = '';
            log('ğŸ‘ï¸ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©...', 'info');

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/currencies?select=code,current_rate,buy_rate,sell_rate&order=code`,
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    }
                );

                const currencies = await response.json();

                if (currencies && currencies.length > 0) {
                    log(`\nğŸ“‹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ© (${currencies.length} Ø¹Ù…Ù„Ø©):\n`, 'info');
                    currencies.forEach(c => {
                        log(`${c.code}: ${c.current_rate?.toFixed(2) || 'N/A'} | Ø´Ø±Ø§Ø¡: ${c.buy_rate?.toFixed(2) || 'N/A'} | Ø¨ÙŠØ¹: ${c.sell_rate?.toFixed(2) || 'N/A'}`, 'info');
                    });
                } else {
                    log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Øª', 'error');
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£: ${error.message}`, 'error');
            }
        };
    </script>
</body>
</html>
